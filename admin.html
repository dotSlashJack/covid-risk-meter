<!DOCTYPE html>
<html>

<head>

    <script src="https://sdk.amazonaws.com/js/aws-sdk-2.410.0.min.js"></script>
    <script src="https://code.jquery.com/jquery-1.10.2.js"></script>
    <script type="text/javascript" src="script.js"></script>

</head>

<body>
    <div style="padding-left: 50px;">

        <h1>Update the Table</h1>
        <p>Click below to upload the new table, it will automatically generate statistics and update the graphics</p>
        <br>

        <div>
            <input type="file" id="tableUpload">
        </div>
        <div>
            <script>
                AWS.config.region = 'us-west-2'; // Region
                AWS.config.credentials = new AWS.CognitoIdentityCredentials({
                    IdentityPoolId: 'us-west-2:cafaba88-27e2-4c26-a632-a8a151dab798',
                });
                var s3 = new AWS.S3({
                    apiVersion: "2006-03-01",
                    params: { Bucket: 'covid-alert-table-upload' }
                });


                var bucketName = 'covid-alert-table-upload';
                var bucketRegion = 'us-west-2';
                var IdentityPoolId = 'us-west-2:cafaba88-27e2-4c26-a632-a8a151dab798';



                function uploadFile(folderName) {
                    var files = document.getElementById("tableUpload").files;
                    if (!files.length) {
                        return alert("Please choose a file to upload first.");
                    }
                    var file = files[0];
                    var fileName = file.name;
                    var folderKey = encodeURIComponent(folderName) + "/";

                    var fileKey = folderKey + fileName;

                    // Use S3 ManagedUpload class as it supports multipart uploads
                    var upload = new AWS.S3.ManagedUpload({
                        params: {
                            Bucket: bucketName,
                            Key: fileKey,
                            Body: file,
                            ACL: "public-read" //TODO: see if I can revoke this later
                        }
                    });

                    var promise = upload.promise();

                    promise.then(
                        function (data) {
                            console.log("Successfully uploaded file.");
                            alert("Your new table finished uploading");
                            //viewAlbum(folderName);
                        },
                        function (err) {
                            return alert("There was an error uploading the file: ", err.message);
                        }
                    );
                }

                /*function deleteFile(folderName) {
                    var files = document.getElementById("tableUpload").files;
                    var file = files[0];
                    var fileName = file.name;
                    var folderKey = encodeURIComponent(folderName) + "/";
                    var fileKey = folderKey + fileName;
                    var bucketInstance = new AWS.S3();
                    var params = {
                        Bucket: bucketName,
                        Key: fileKey
                    };

                s3.deleteObject(params, function (err, data) {
                        if (data) {
                            console.log("File deleted successfully");
                        }
                        else {
                            alert("Error deleting the old table: " + err);
                        }
                    });
                }*/
                /*
                    @param folderName the name of the folder inside the s3 bucket that contains the table
                */
                function updateTable(folderName) {
                    deleteFile(folderName);
                    uploadFile(folderName);
                }
            </script>
            <!--<button onclick="s3upload('current_table')">Submit</button>-->
            <br><button onclick="updateTable('current_table')">Upload New Table</button>
        </div>
    </div>
</body>

</html>